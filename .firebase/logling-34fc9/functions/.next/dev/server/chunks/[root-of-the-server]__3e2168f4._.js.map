{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/maccrey/Development/Loglingo/src/infrastructure/observability/sentry-server.ts"],"sourcesContent":["import { ClientLogEvent, LogLevel } from \"@/domain/observability\";\n\ntype ParsedDsn = {\n  protocol: string;\n  host: string;\n  projectId: string;\n  key: string;\n};\n\nfunction fallbackId() {\n  return Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2);\n}\n\nexport function parseSentryDsn(dsn: string): ParsedDsn | null {\n  try {\n    const url = new URL(dsn);\n    const projectId = url.pathname.replace(\"/\", \"\");\n    if (!projectId) return null;\n    if (!url.username) return null;\n\n    return {\n      protocol: url.protocol.replace(\":\", \"\"),\n      host: url.host,\n      projectId,\n      key: url.username,\n    };\n  } catch {\n    return null;\n  }\n}\n\ntype EnvelopeParts = { url: string; body: string };\n\nfunction parseStack(stack?: string) {\n  if (!stack) return undefined;\n  const frames = stack\n    .split(\"\\n\")\n    .slice(1)\n    .map((line) => line.trim())\n    .map((line) => {\n      const withFunction = line.match(/^at (.+?) \\((.*):(\\d+):(\\d+)\\)$/);\n      const withoutFunction = line.match(/^at (.*):(\\d+):(\\d+)$/);\n\n      if (withFunction) {\n        return {\n          function: withFunction[1],\n          filename: withFunction[2],\n          lineno: Number(withFunction[3]),\n          colno: Number(withFunction[4]),\n        };\n      }\n\n      if (withoutFunction) {\n        return {\n          filename: withoutFunction[1],\n          lineno: Number(withoutFunction[2]),\n          colno: Number(withoutFunction[3]),\n        };\n      }\n\n      return null;\n    })\n    .filter(Boolean);\n\n  return frames.length > 0 ? { frames } : undefined;\n}\n\nexport function buildSentryEnvelope(dsn: string, event: ClientLogEvent): EnvelopeParts | null {\n  const parsed = parseSentryDsn(dsn);\n  if (!parsed) return null;\n\n  const eventId = typeof crypto !== \"undefined\" && crypto.randomUUID ? crypto.randomUUID() : fallbackId();\n  const header = {\n    event_id: eventId,\n    dsn,\n    sent_at: new Date().toISOString(),\n    sdk: { name: \"loglingo-sentry-lite\", version: \"0.1.0\" },\n  };\n\n  const payload = {\n    event_id: eventId,\n    timestamp: Date.now() / 1000,\n    level: (event.level as LogLevel) ?? \"error\",\n    platform: \"javascript\",\n    message: { formatted: event.message },\n    tags: {\n      type: event.type ?? \"log\",\n    },\n    exception: event.stack\n      ? {\n          values: [\n            {\n              type: \"Error\",\n              value: event.message,\n              stacktrace: parseStack(event.stack),\n            },\n          ],\n        }\n      : undefined,\n    extra: event.context,\n  };\n\n  const body = `${JSON.stringify(header)}\\n${JSON.stringify({ type: \"event\" })}\\n${JSON.stringify(payload)}`;\n\n  const url = `${parsed.protocol}://${parsed.host}/api/${parsed.projectId}/envelope/`;\n  return { url, body };\n}\n\nexport async function sendSentryEvent(event: ClientLogEvent) {\n  const dsn = process.env.SENTRY_DSN;\n  if (!dsn) return false;\n\n  const envelope = buildSentryEnvelope(dsn, event);\n  if (!envelope) return false;\n\n  try {\n    await fetch(envelope.url, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/x-sentry-envelope\" },\n      body: envelope.body,\n    });\n    return true;\n  } catch (error) {\n    console.error(\"Sentry send failed\", error);\n    return false;\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 166, "column": 0}, "map": {"version":3,"sources":["file:///Users/maccrey/Development/Loglingo/src/infrastructure/observability/server-logger.ts"],"sourcesContent":["import { ClientLogEvent, RumMetricPayload } from \"@/domain/observability\";\nimport { sendSentryEvent } from \"./sentry-server\";\n\nfunction formatRum(metric: RumMetricPayload) {\n  const detail = {\n    value: metric.value,\n    path: metric.pathname,\n    nav: metric.navigationType,\n    visibility: metric.visibilityState,\n    ect: metric.effectiveConnectionType,\n  };\n  console.info(`[RUM] ${metric.metric}`, detail);\n}\n\nexport async function persistRumMetric(metric: RumMetricPayload) {\n  formatRum(metric);\n}\n\nexport async function persistClientLog(event: ClientLogEvent) {\n  if (event.level === \"error\") {\n    console.error(\"[client-error]\", event.message, event.context, event.stack);\n  } else if (event.level === \"warn\") {\n    console.warn(\"[client-log]\", event.message, event.context);\n  } else {\n    console.info(\"[client-log]\", event.message, event.context);\n  }\n\n  await sendSentryEvent(event);\n}\n"],"names":[],"mappings":";;;;;;AACA;;AAEA,SAAS,UAAU,MAAwB;IACzC,MAAM,SAAS;QACb,OAAO,OAAO,KAAK;QACnB,MAAM,OAAO,QAAQ;QACrB,KAAK,OAAO,cAAc;QAC1B,YAAY,OAAO,eAAe;QAClC,KAAK,OAAO,uBAAuB;IACrC;IACA,QAAQ,IAAI,CAAC,CAAC,MAAM,EAAE,OAAO,MAAM,EAAE,EAAE;AACzC;AAEO,eAAe,iBAAiB,MAAwB;IAC7D,UAAU;AACZ;AAEO,eAAe,iBAAiB,KAAqB;IAC1D,IAAI,MAAM,KAAK,KAAK,SAAS;QAC3B,QAAQ,KAAK,CAAC,kBAAkB,MAAM,OAAO,EAAE,MAAM,OAAO,EAAE,MAAM,KAAK;IAC3E,OAAO,IAAI,MAAM,KAAK,KAAK,QAAQ;QACjC,QAAQ,IAAI,CAAC,gBAAgB,MAAM,OAAO,EAAE,MAAM,OAAO;IAC3D,OAAO;QACL,QAAQ,IAAI,CAAC,gBAAgB,MAAM,OAAO,EAAE,MAAM,OAAO;IAC3D;IAEA,MAAM,IAAA,0MAAe,EAAC;AACxB"}},
    {"offset": {"line": 201, "column": 0}, "map": {"version":3,"sources":["file:///Users/maccrey/Development/Loglingo/src/app/api/observability/rum/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { RumMetricPayload } from \"@/domain/observability\";\nimport { persistRumMetric } from \"@/infrastructure/observability/server-logger\";\n\nconst headers = { \"Cache-Control\": \"no-store, max-age=0\" };\n\nfunction isRumMetric(value: unknown): value is RumMetricPayload {\n  if (!value || typeof value !== \"object\") return false;\n  const metric = (value as RumMetricPayload).metric;\n  const allowed = [\"LCP\", \"CLS\", \"INP\", \"TTFB\"];\n  return (\n    allowed.includes(metric as string) &&\n    typeof (value as RumMetricPayload).value === \"number\" &&\n    typeof (value as RumMetricPayload).sessionId === \"string\"\n  );\n}\n\nexport async function POST(req: NextRequest) {\n  const body = await req.json().catch(() => null);\n  const metric = (body as { payload?: RumMetricPayload })?.payload ?? body;\n\n  if (!isRumMetric(metric)) {\n    return NextResponse.json({ error: \"invalid metric\" }, { status: 400, headers });\n  }\n\n  await persistRumMetric(metric);\n  return NextResponse.json({ ok: true }, { status: 200, headers });\n}\n"],"names":[],"mappings":";;;;AAAA;AAEA;;;AAEA,MAAM,UAAU;IAAE,iBAAiB;AAAsB;AAEzD,SAAS,YAAY,KAAc;IACjC,IAAI,CAAC,SAAS,OAAO,UAAU,UAAU,OAAO;IAChD,MAAM,SAAS,AAAC,MAA2B,MAAM;IACjD,MAAM,UAAU;QAAC;QAAO;QAAO;QAAO;KAAO;IAC7C,OACE,QAAQ,QAAQ,CAAC,WACjB,OAAO,AAAC,MAA2B,KAAK,KAAK,YAC7C,OAAO,AAAC,MAA2B,SAAS,KAAK;AAErD;AAEO,eAAe,KAAK,GAAgB;IACzC,MAAM,OAAO,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM;IAC1C,MAAM,SAAS,AAAC,MAAyC,WAAW;IAEpE,IAAI,CAAC,YAAY,SAAS;QACxB,OAAO,2KAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAiB,GAAG;YAAE,QAAQ;YAAK;QAAQ;IAC/E;IAEA,MAAM,IAAA,2MAAgB,EAAC;IACvB,OAAO,2KAAY,CAAC,IAAI,CAAC;QAAE,IAAI;IAAK,GAAG;QAAE,QAAQ;QAAK;IAAQ;AAChE"}}]
}